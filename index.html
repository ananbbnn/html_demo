<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/bmi.css">
    <style>
        
    </style>
    <script src="js/bmi.js"> </script>
        
        
    <title>BMI計算機</title>
</head>
<body>
    <div class="main-title">BMI計算機</div>

    <div id="record"></div>
    <button style="background-color: red;" hidden="true" id="clear" type="button">刪除</button>

    <form action="">
        <label for="username">姓名</label>
        <input id="username" name="username" type="text" placeholder="王小明"><br>
        <label for="age">年齡</label>
        <input id="age" name="age" type="number" placeholder="18"><br>
        <label for="height">身高</label>
        <input id="height" name="height" type="number" placeholder="180"><br>
        <label for="weight">體重</label>
        <input id="weight" name="weight" type="number" placeholder="80"><br> 

        <div class="panel1">
            <input type="radio" name="sex" id="male" checked value="男">男
            <input type="radio" name="sex" id="female" value="女">女
           

            <label for="country">|| 居住城市</label>
            <select name="country" id="country">
                <option value="台北市">台北市</option>
                <option value="新北市">新北市</option>
                <option value="台中市">台中市</option>
                <option value="台南市">台南市</option>
                <option value="高雄市">高雄市</option>

            </select>

        </div>   
            <button id="btn" type="button" onclick="countBmi()">計算</button>
            <button id="saveTable" type="button" onclick="save()" style="background-color: chartreuse;">儲存表格</button>
            <a href="index.html">首頁</a>
        
    </form>

    <div>
        <table id="info" border="1">
            <thead>
                <tr>
                    <th>姓名</th>
                    <th>年齡</th>
                    <th>身高</th>
                    <th>體重</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><span class="name"></span></td>
                    <td><span class="age"></span></td>
                    <td><span class="height"></span></td>
                    <td><span class="weight"></span></td>
                </tr>
            </tbody>
        </table>
    </div>

    <div id="result" hidden="true">
        BMI:<span class="bmi"></span>
        <p class="comment"></p>
    </div>

    <div id="tableRecord">
        <table border="2">
            <thead>
                <tr>
                    <th>姓名</th>
                    <th>年齡</th>
                    <th>性別</th>
                    <th>身高</th>
                    <th>體重</th>
                    <th>BMI</th>
                </tr>
            </thead>
        </table>





    </div>

    

<script>
    const clearRecordBtn = document.querySelector("#clear")

    
    
    function save(){
        let datas = JSON.parse(localStorage.getItem("datas"));
        console.log(datas);

        if(datas == null || datas.length==0){
            alert("目前無紀錄");
            return;
        }
    

        let jsonStr = JSON.stringify(datas);
        console.log(jsonStr);

        const blobData = new Blob([jsonStr],{type:"application/json"});
        console.log(blobData)

        const url = URL.createObjectURL(blobData);
        console.log(url);

        const a = document.createElement("a");
        a.href=url;
        a.download="records.json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }


    clearRecordBtn.addEventListener("click",function(){
        if(!confirm("是否確定刪除?")){
        return;
    }


        localStorage.removeItem("record");
        localStorage.removeItem("datas");
        data.total = 0;
        data.count = 0;
        datas = [];
        document.querySelector("#record").innerHTML = "";
        document.querySelector("#tableRecord").innerHTML = "";
    })

    let data = {
        total:0,
        count:0
    }
    let datas = JSON.parse(localStorage.getItem("datas")) || [];


    record = JSON.parse(localStorage.getItem("record"));
    if(record){
        data = record;
        let avg = (data.total/data.count).toFixed(2)
        document.querySelector("#record").innerHTML = `紀錄人數:${data.count} 平均BMI:${avg}`
    }
    console.log(record);

    function addRow(data){
        return `
        <tr>
            <td>${data.name}</td>
            <td>${data.age}</td>
            <td>${data.sex}</td>
            <td>${data.height}</td>
            <td>${data.weight}</td>
            <td>${data.bmi}</td>
        </tr>

        `;
    }

    function renderTable(datas){
        tableData = "";
        for(let i=0;i<datas.length; i++ ){
            console.log((i+1,datas[i]));
            tableData += addRow(datas[i]);
            
        }
        let tableHtml = `
        <table border="2">
            <thead>
                <tr>
                    <th>姓名</th>
                    <th>年齡</th>
                    <th>性別</th>
                    <th>身高</th>
                    <th>體重</th>
                    <th>BMI</th>
                </tr>
            </thead>
            <tbody>
                ${tableData}
            </tbody>
        </table>
        `;

        console.log(tableHtml);
        document.querySelector("#tableRecord").innerHTML = tableHtml
        
    }
    

    function getBmi(height,weight){
        const bmi = weight/(height/100)**2;
        return bmi.toFixed(2);
    }
    function countBmi(){
        let h = document.getElementById("height").value;
        let w = document.getElementById("weight").value;
        if(h<=0||w<=0){
            alert("請輸入正確數值")
        }else{
            document.querySelector("#result").hidden = false;
            document.querySelector("#clear").hidden = false;
            let bmi = getBmi(h,w);
            console.log(bmi,getComment(bmi));
            
            // document.querySelector("#result").innerHTML = `<h1>BMI:${bmi}<br>${getComment(bmi)}</h1>`
            const bmiResult = document.querySelector(".bmi");
            const comment = document.querySelector(".comment");
            const username = document.getElementById("username").value;
            const age = document.getElementById("age").value;
            const height = document.getElementById("height").value;
            const weight = document.getElementById("weight").value;
            const sexEl = document.querySelector("input[name='sex']:checked")
            let sex = sexEl.value;
            bmiResult.innerText = bmi;
            bmiResult.style.color = getComment(bmi)[1];
            document.querySelector(".comment").innerText = getComment(bmi)[0];
            document.querySelector(".name").innerText = username;
            document.querySelector(".age").innerText = age;
            document.querySelector(".height").innerText = height;
            document.querySelector(".weight").innerText = weight;
            console.log(username,age,height,weight);


            data.total += Number(bmi);
            data.count += 1;
            let avg = (data.total/data.count).toFixed(2)
            document.querySelector("#record").innerHTML = `紀錄人數:${data.count} 平均BMI:${avg}`

            localStorage.setItem("record",JSON.stringify(data));

            let person={
                name:username,
                age:age,
                sex:sex,
                height:height,
                weight:weight,
                bmi:bmi
            }
            
            datas.push(person);
            localStorage.setItem("datas",JSON.stringify(datas));
            renderTable(datas);

            
            
 
            
            
            

        }
        
        
    }
   


    // let btn = document.querySelector("#btn");
    // btn.addEventListener('click',countBmi);

    















    // let x = 10;
    // let y = 20;
    // let z = x + y;

    // if(x>10){

    // }else if(y>20){

    // }else{
    //     console.log(x,y,z);
    // }

    // x = "10";
    // y = 10;

    // console.log(x === y);

    // let height = prompt("請輸入身高:");
    // let weight = prompt("請輸入體重:");
    // let bmi = getBmi(height,weight);

    // alert("BMI:"+bmi)
    

    // function getBmi(height,weight){
    //     const bmi = weight/(height/100)**2;
        
    //     return bmi.toFixed(2);
    // }
    

    // const pi = 3.1415926;
    // // const 宣告常數
    // let radius = prompt("請輸入半徑:");
    // if (isNaN(radius)){
    //     alert("請輸入正確數值!");
        
    // }else{
    //     let area =radius*radius*pi;
    //     const result = "半徑為:"+radius+" 面積為:"+area;
    //     console.log(isNaN(result));
    //     document.write("<h2>"+result+"</h2>")
    //     alert(result);
    // }
    

    
    
    




</script>
    
</body>
</html>